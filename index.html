<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Ziel: 10</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f3f4f6}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:#fff; border-radius:14px; padding:10px 12px; box-shadow:0 6px 20px rgba(0,0,0,.08);
      flex-wrap:wrap;
    }
    .stat{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-weight:600}
    .btn{
      border:0;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;
      background:#111827;color:#fff;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    canvas{
      width:100%; height:auto; display:block; margin-top:12px;
      background:linear-gradient(#e5eefc,#f8fafc 45%,#f6e8d5 46%,#f3dcc2);
      border-radius:18px; box-shadow:0 10px 28px rgba(0,0,0,.12);
      touch-action:none;
    }
    .overlay{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(15,23,42,.62); padding:18px;
    }
    .card{
      width:min(520px,100%); background:#fff; border-radius:18px; padding:16px;
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      text-align:center;
    }
    .card h2{margin:0 0 8px}
    .stars{font-size:34px; letter-spacing:4px; margin:10px 0}
    .small{color:#475569; font-size:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .row .btn{flex:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="text-align:center; margin-bottom:12px;">
  <img src="logo.png" alt="Logo" style="height:80px; display:block; margin:0 auto 8px;">
  <h1 style="margin:0; font-size:28px; font-weight:800; color:#1e293b;">
    Frau Anna Deutsch für Kinder
  </h1>
</div>

    <div class="topbar">
      <div class="stat">
        <div class="pill">Treffer: <span id="hits">0</span>/10</div>
        <div class="pill">Würfe übrig: <span id="throwsLeft">15</span></div>
        <div class="pill">Status: <span id="status">ziehen & loslassen</span></div>
      </div>
      <div class="stat">
        <button class="btn" id="restartBtn">Neu</button>
      </div>
    </div>

    <canvas id="game" width="960" height="540"></canvas>
  </div>

  <div class="overlay" id="overlay">
    <div class="card">
      <h2 id="resultTitle">Ergebnis</h2>
      <div class="stars" id="stars">⭐️</div>
      <div class="small" id="resultText"></div>
      <div class="row">
        <button class="btn" id="playAgainBtn">Nochmal</button>
        <button class="btn" id="closeBtn" style="background:#334155">Schließen</button>
      </div>
    </div>
  </div>

  <script>
    // ====== НАСТРОЙКИ ======
    const TARGET_HITS = 10;
    const MAX_THROWS = 15;

    // 3 звезды: победа и осталось >= 3 бросков, иначе 2 звезды, иначе 1
    const STAR_3_LEFT_AT_LEAST = 3;

    // Физика (это ближе к "первому варианту")
    const GRAVITY = 1400;      // было 1700 — чуть мягче
    const AIR_DRAG = 0.995;
    const RESTITUTION = 0.55;
    const FRICTION = 0.985;
    const THROW_POWER = 5.2;   // средне: не слишком пушка, но и не "сам летит"

    // ====== DOM ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    const uiHits = document.getElementById('hits');
    const uiThrowsLeft = document.getElementById('throwsLeft');
    const uiStatus = document.getElementById('status');

    const overlay = document.getElementById('overlay');
    const resultTitle = document.getElementById('resultTitle');
    const starsEl = document.getElementById('stars');
    const resultText = document.getElementById('resultText');

    const restartBtn = document.getElementById('restartBtn');
    const playAgainBtn = document.getElementById('playAgainBtn');
    const closeBtn = document.getElementById('closeBtn');

    // ====== РЕСУРСЫ ======
    function loadImage(src) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve({ ok:true, img });
        img.onerror = () => resolve({ ok:false, img:null });
        img.src = src;
      });
    }
    function makeAudio(src) {
      const a = new Audio(src);
      a.preload = 'auto';
      return a;
    }

    const numberAudio = Array.from({length: 10}, (_, i) => makeAudio(`${i+1}.mp3`));
    const hitSound = makeAudio('zwuk.mp3');
    hitSound.volume = 0.25;

    let assets = {
      cup: { ok:false, img:null },
      ball: { ok:false, img:null }
    };

    // ====== МИР ======
    const world = {
      floorY: 380,
      cup: {
        x: 700,
        y: 0,            // выставим ниже
        w: 160,
        h: 120,
        hitR: 60,        // "средне": не слишком огромная
        hitYOffset: 20   // хит-зона внутри миски чуть ниже центра
      },
      ball: {
        x: 220,
        y: 0,            // выставим на стол
        r: 20,
        vx: 0,
        vy: 0,
        state: 'ready',  // ready | dragging | flying | settled
        startX: 220,
        startY: 0
      }
    };

    let hits = 0;
    let throwsUsed = 0;
    let lastTime = 0;
    let rafId = null;

    // drag
    let pointerDown = false;
    let dragFrom = {x:0,y:0};

    // чтобы попадание считалось один раз за бросок
    let hitRegisteredThisThrow = false;

    // кружочки — анимация "пульса" при заполнении
    const dotPulse = new Array(TARGET_HITS).fill(0);

    // ====== УТИЛИТЫ ======
    function dist(ax, ay, bx, by) { return Math.hypot(ax-bx, ay-by); }

    function setStatus(text) { uiStatus.textContent = text; }

    function playAudioSafe(audio) {
      try {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    function resetBall() {
      const b = world.ball;
      b.x = b.startX;
      b.y = b.startY;
      b.vx = 0;
      b.vy = 0;
      b.state = 'ready';
      pointerDown = false;
      hitRegisteredThisThrow = false;
    }

    function resetGame() {
      hits = 0;
      throwsUsed = 0;
      uiHits.textContent = hits;
      uiThrowsLeft.textContent = (MAX_THROWS - throwsUsed);
      overlay.style.display = 'none';
      setStatus('ziehen & loslassen');
      for (let i=0;i<dotPulse.length;i++) dotPulse[i]=0;
      resetBall();
    }

    function showResult() {
      const throwsLeft = MAX_THROWS - throwsUsed;

      let stars = 1;
      if (hits >= TARGET_HITS) {
        stars = (throwsLeft >= STAR_3_LEFT_AT_LEAST) ? 3 : 2;
      } else {
        stars = 1;
      }

      resultTitle.textContent = (hits >= TARGET_HITS) ? 'Super!' : 'Nochmal!';
      starsEl.textContent = '⭐️'.repeat(stars);
      resultText.textContent = `Treffer: ${hits}/${TARGET_HITS}. Würfe übrig: ${throwsLeft}.`;

      overlay.style.display = 'flex';
      setStatus('fertig');
    }

    function stopBallAndFinishThrow(delayMs = 350) {
      // Остановить мяч сразу и завершить бросок
      const b = world.ball;
      b.vx = 0;
      b.vy = 0;
      b.state = 'settled';
      setTimeout(() => {
        if (overlay.style.display === 'flex') return; // уже показали результат
        if (hits >= TARGET_HITS) return;              // победа уже показалась
        if (throwsUsed >= MAX_THROWS) {
          showResult();
        } else {
          resetBall();
          setStatus('nächster Wurf');
        }
      }, delayMs);
    }

    async function onHit() {
      if (hitRegisteredThisThrow) return;
      hitRegisteredThisThrow = true;

      hits = Math.min(TARGET_HITS, hits + 1);
      uiHits.textContent = hits;

      // анимация кружочка
      dotPulse[hits - 1] = 1;

      // звук попадания + число
      playAudioSafe(hitSound);
      const idx = hits - 1;
      if (idx >= 0 && idx < numberAudio.length) {
        setTimeout(() => playAudioSafe(numberAudio[idx]), 120);
      }

      // ВАЖНО: после попадания мяч больше НЕ летит
      stopBallAndFinishThrow(420);

      if (hits >= TARGET_HITS) {
        // покажем победу чуть позже (после небольшого "стоп" эффекта)
        setTimeout(() => showResult(), 450);
      }
    }

    // ====== ВВОД ======
    function getPointerPos(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      return {x,y};
    }

    function canStartDrag(p) {
      const b = world.ball;
      return b.state === 'ready' && dist(p.x,p.y,b.x,b.y) <= b.r * 1.2;
    }

    canvas.addEventListener('pointerdown', (e) => {
      if (overlay.style.display === 'flex') return;
      const p = getPointerPos(e);
      if (!canStartDrag(p)) return;
      pointerDown = true;
      world.ball.state = 'dragging';
      dragFrom = { x: world.ball.x, y: world.ball.y };
      setStatus('loslassen');
      canvas.setPointerCapture(e.pointerId);
    });

    // Ограничиваем натяжение, чтобы не было "самонаведения"
    canvas.addEventListener('pointermove', (e) => {
      if (!pointerDown) return;
      const p = getPointerPos(e);

      const b = world.ball;
      const maxPull = 150;

      let dx = p.x - dragFrom.x;
      let dy = p.y - dragFrom.y;
      const len = Math.hypot(dx, dy) || 1;

      if (len > maxPull) {
        dx = dx / len * maxPull;
        dy = dy / len * maxPull;
      }

      b.x = dragFrom.x + dx;
      b.y = dragFrom.y + dy;
    });

    function releaseThrow() {
      if (!pointerDown) return;
      pointerDown = false;

      const b = world.ball;
      if (b.state !== 'dragging') return;

      const dx = dragFrom.x - b.x;
      const dy = dragFrom.y - b.y;

      if (Math.hypot(dx,dy) < 10) {
        resetBall();
        setStatus('ziehen & loslassen');
        return;
      }

      b.state = 'flying';
      hitRegisteredThisThrow = false;

      b.vx = dx * THROW_POWER;
      b.vy = dy * THROW_POWER;

      throwsUsed++;
      uiThrowsLeft.textContent = (MAX_THROWS - throwsUsed);
      setStatus('Wurf!');
    }

    canvas.addEventListener('pointerup', releaseThrow);
    canvas.addEventListener('pointercancel', releaseThrow);

    // ====== ФИЗИКА + ЛОГИКА ======
    function update(dt) {
      // анимация кружочков
      for (let i=0;i<dotPulse.length;i++){
        if (dotPulse[i] > 0) {
          dotPulse[i] = Math.max(0, dotPulse[i] - dt*3.5);
        }
      }

      const b = world.ball;
      if (b.state === 'flying') {
        b.vy += GRAVITY * dt;
        b.x += b.vx * dt;
        b.y += b.vy * dt;

        b.vx *= Math.pow(AIR_DRAG, dt * 60);
        b.vy *= Math.pow(AIR_DRAG, dt * 60);

        // границы по x
        if (b.x < b.r) { b.x = b.r; b.vx *= -0.6; }
        if (b.x > canvas.width - b.r) { b.x = canvas.width - b.r; b.vx *= -0.6; }

        // пол (стол)
        if (b.y > world.floorY - b.r) {
          b.y = world.floorY - b.r;
          b.vy *= -RESTITUTION;
          b.vx *= FRICTION;

          // если остановился — завершить бросок
          if (Math.abs(b.vy) < 80 && Math.abs(b.vx) < 80) {
            b.vx = 0; b.vy = 0;
            b.state = 'settled';
            setTimeout(() => {
              if (overlay.style.display === 'flex') return;
              if (hits >= TARGET_HITS) return;
              if (throwsUsed >= MAX_THROWS) showResult();
              else { resetBall(); setStatus('nächster Wurf'); }
            }, 320);
          }
        }

        // попадание в миску (центр с Y-смещением внутрь)
        if (!hitRegisteredThisThrow) {
          const cup = world.cup;
          const cx = cup.x;
          const cy = cup.y + cup.hitYOffset;
          if (dist(b.x, b.y, cx, cy) <= cup.hitR) {
            onHit();
          }
        }

        // если улетел далеко
        if (b.y > canvas.height + 200 || b.y < -400) {
          b.state = 'settled';
          setTimeout(() => {
            if (overlay.style.display === 'flex') return;
            if (hits >= TARGET_HITS) return;
            if (throwsUsed >= MAX_THROWS) showResult();
            else { resetBall(); setStatus('nächster Wurf'); }
          }, 200);
        }
      }
    }

    // ====== РИСОВАНИЕ ======
    function drawDotsPretty() {
      const total = TARGET_HITS;
      const startX = 20;
      const y = 88;
      const r = 13;
      const spacing = 32;

      for (let i=0;i<total;i++){
        const x = startX + i*spacing;

        // лёгкая тень под кружком
        ctx.save();
        ctx.globalAlpha = 0.15;
        ctx.fillStyle = '#0f172a';
        ctx.beginPath();
        ctx.ellipse(x, y+10, r*0.9, r*0.55, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();

        if (i < hits) {
          // заполненный с glow + пульс
          const pulse = dotPulse[i]; // 0..1
          const scale = 1 + pulse*0.35;

          ctx.save();
          ctx.translate(x, y);
          ctx.scale(scale, scale);

          // градиент внутри
          const g = ctx.createRadialGradient(-4,-6, 2, 0,0, r*1.3);
          g.addColorStop(0, '#93c5fd');
          g.addColorStop(0.55, '#3b82f6');
          g.addColorStop(1, '#1d4ed8');

          ctx.beginPath();
          ctx.arc(0,0,r,0,Math.PI*2);
          ctx.fillStyle = g;
          ctx.shadowColor = 'rgba(59,130,246,.75)';
          ctx.shadowBlur = 18;
          ctx.fill();

          // блик
          ctx.beginPath();
          ctx.ellipse(-4,-5, r*0.35, r*0.25, -0.4, 0, Math.PI*2);
          ctx.fillStyle = 'rgba(255,255,255,.55)';
          ctx.shadowBlur = 0;
          ctx.fill();

          ctx.restore();
        } else {
          // пустой — аккуратный обвод + внутренний фон
          ctx.save();
          ctx.beginPath();
          ctx.arc(x,y,r,0,Math.PI*2);
          ctx.fillStyle = 'rgba(255,255,255,.75)';
          ctx.fill();

          ctx.lineWidth = 2;
          ctx.strokeStyle = 'rgba(100,116,139,.85)';
          ctx.stroke();
          ctx.restore();
        }
      }
    }

    function draw() {
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // линия стола
      ctx.save();
      ctx.strokeStyle = 'rgba(15,23,42,.30)';
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(0, world.floorY);
      ctx.lineTo(canvas.width, world.floorY);
      ctx.stroke();
      ctx.restore();

      // заголовок
      ctx.save();
      ctx.fillStyle = 'rgba(15,23,42,.78)';
      ctx.font = '800 28px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(`Ziel: ${TARGET_HITS}`, 20, 44);
      ctx.restore();

      // кружочки
      drawDotsPretty();

      // миска
      const cup = world.cup;
      if (assets.cup.ok) {
        ctx.drawImage(assets.cup.img, cup.x - cup.w/2, cup.y - cup.h/2, cup.w, cup.h);
      } else {
        ctx.save();
        ctx.fillStyle = 'rgba(59,130,246,.35)';
        ctx.beginPath();
        ctx.ellipse(cup.x, cup.y, cup.w*0.35, cup.h*0.28, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }

      // шарик
      const b = world.ball;
      if (assets.ball.ok) {
        ctx.drawImage(assets.ball.img, b.x - b.r, b.y - b.r, b.r*2, b.r*2);
      } else {
        ctx.save();
        ctx.fillStyle = 'rgba(2,132,199,.85)';
        ctx.beginPath();
        ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }

      // линия натяжения
      if (b.state === 'dragging') {
        ctx.save();
        ctx.strokeStyle = 'rgba(15,23,42,.25)';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(dragFrom.x, dragFrom.y);
        ctx.lineTo(b.x, b.y);
        ctx.stroke();
        ctx.restore();
      }
    }

    // ====== ЦИКЛ ======
    function loop(t) {
      const time = t / 1000;
      const dt = Math.min(0.033, time - lastTime || 0.016);
      lastTime = time;

      update(dt);
      draw();

      rafId = requestAnimationFrame(loop);
    }

    // ====== КНОПКИ ======
    restartBtn.addEventListener('click', resetGame);
    playAgainBtn.addEventListener('click', resetGame);
    closeBtn.addEventListener('click', () => overlay.style.display = 'none');

    // ====== СТАРТ ======
    (async function start() {
      assets.cup = await loadImage('cup.png');
      assets.ball = await loadImage('ball.png');

      // "опустить" миску на стол (чтобы ощущения совпадали)
      world.cup.y = world.floorY - 40;

      // старт шарика на столе
      world.ball.startY = world.floorY - world.ball.r;
      resetGame();

      cancelAnimationFrame(rafId);
      lastTime = 0;
      rafId = requestAnimationFrame(loop);
    })();
  </script>
</body>
</html>

